
<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="json2.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
    <script src="backbone-relational.js"></script>
    <title>Backbone test</title>
    
    <link rel="stylesheet" type="text/css" href="reset.css" />
    <link rel="stylesheet" type="text/css" href="960.css" />
    
    <style>
        #content {
            border: 3px solid black;
            width: 1004px;
            padding: 10px;
            margin: 20px auto;
        }
        #content .section {
            margin: 10px;
            padding: 10px;
            overflow: auto;
        }
        #content .section .item {
            margin-top: 10px;
            margin-bottom: 10px;
            display: inline-block;
            vertical-align: top;
            float: none;
            overflow: hidden;
            background-color: white;
        }
        h1, h2, h3 {
            margin: 0px;
        }
        h1 {
            font-size: 2em;
        }
        h2 {
            font-size: 1.5em;
        }
        h3 {
            font-size: 1.2em;
        }                
        #jsoncode {
            padding: 25px;
        }
        .border1 {
            border: 1px solid black;
            padding: 5px;
        }
        .border2 {
            border: 2px solid black;
        }
    </style>
</head>
<body>

<script>

$(function() {

    Backbone.Model.prototype.idAttribute = "_id";

    Backbone.Collection.prototype.reorder = function(order) {
        var new_models = []
        for (var i=0; i < order.length; i++) {
            new_models[i] = this.get(order[i])
        }
        this.models = new_models
        return this
    }
    
    window.Content = Backbone.RelationalModel.extend({
        relations: [{
            type: Backbone.HasMany,
            key: 'sections',
            relatedModel: 'Section',
            collectionType: 'SectionCollection',
            includeInJSON: '_id',
            reverseRelation: {
                key: 'parent',
                includeInJSON: false
            },
        }],
        urlRoot: '/api/content',
        initialize: function() {
            var self = this 
            this.get('sections').url = function() { return self.url() + "/sections" }
        },
        parse: function(data) {
            $("#jsoncode").html(JSON.stringify(data))
            return data
        }
    })
    
    window.Section = Backbone.RelationalModel.extend({
        relations: [{
            type: Backbone.HasMany,
            key: 'items',
            relatedModel: 'Item',
            collectionType: 'ItemCollection',
            includeInJSON: "_id",
            reverseRelation: {
                key: 'parent',
                includeInJSON: false
            },
        }],
        defaults: {width: 16},
        initialize: function() {
            // this is a hack to force "items" to be a collection rather than an empty list 
            if (this.get('items').length==0)
                this.set({items: [,]})
            var self = this 
            this.get('items').url = function() { return self.url() + "/items" }
            //console.log("section created", this)
        }
    })
    
    window.Item = Backbone.RelationalModel.extend({
        initialize: function() {
            //console.log("item created", this)   
        },
        defaults: {width: 4}
    })
    
    window.SectionCollection = Backbone.Collection.extend({
        model: Section,
        initialize: function() {
            //console.log("sectioncollection created", this)   
        }    
    });
    
    window.ItemCollection = Backbone.Collection.extend({
        model: Item,
        initialize: function() {
            //console.log("itemcollection created", this)   
        } 
    })
    
    window.ItemView = Backbone.View.extend({
        tagName: "span",
        className: "item",
        render: function() {
            //console.log("itemview render")
            this.el.html("<div class='border1'><h3 class='itemtitle'></h3><div class='attributes'></div></div>")
            this.$('.itemtitle').text(this.model.get("title"))
            this.$('.attributes').text("")
            var self = this
            _.each(_.keys(this.model.attributes), function(attr) {
                if (attr!="title" && attr!="_id" && attr!="parent" && attr!="width")
                    self.$('.attributes').append("<div class='attr_" + attr + "'><b>" + attr + ":</b> " + self.model.get(attr) + "</div>")
            })
            this.el.addClass("grid_" + this.model.get('width'))
            return this
        },
        events: {
            "click .itemtitle": "edit"
        },
        initialize: function() {
            this.el = $(this.el)
            this.el.attr('id', this.model.id)
            this.model.bind('change', this.render, this)
            this.render()
            //console.log("itemview initialized")
        },
        edit: function() {
          this.model.save({"title": this.model.get("title") + " :)"})
        }    
    })
    
    window.SectionView = Backbone.View.extend({
        tagName: "div",
        className: "section border2",
        render: function() {
            //console.log("section rendering")
            this.el.html("<div class=''><h2 class='sectiontitle'></h2><div class='items'></div></div>")
            this.makeSortable()
            this.update()
            return this
        },
        events: {
            "click .sectiontitle": "edit"
        },
        initialize: function() {
            this.itemViews = {}
            this.el = $(this.el)
            this.el.addClass("container_" + this.model.get("width"))
            this.el.attr('id', this.model.id)
            this.model.bind("change", this.update, this)
            this.model.bind("update:items", this.updateItems, this)
            this.model.bind("add:items", this.addItems, this)
            this.model.bind("remove:items", this.removeItems, this)
            this.render()
            for (var i=0; i < this.model.get('items').length; i++)
                this.addItems(this.model.get('items').at(i), this.collection)
        },
        makeSortable: function() {
            var self = this
            this.$('.items').sortable({
                update: function(event, ui) {
                    // get the post-sort item order (as a list of id's) and save the new collection order 
                    var new_order = self.$('.items').sortable("toArray")
                    self.model.get('items').reorder(new_order)
                    self.model.save()
                },
                opacity: 0.6,
                tolerance: "pointer"
            })
        },
        edit: function() {
          alert('editing! ' + this.model.attributes)
        },
        updateItems: function(model, coll) {
            //alert('update items')
        },
        addItems: function(model, coll) {
            //console.log("addItems:", model)
            this.itemViews[model.cid] = new ItemView({model: model})
            this.$(".items").append(this.itemViews[model.cid].el)
        },
        removeItems: function(model, coll) {
            //console.log("removeItems:", model)
            $(this.itemViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
            delete this.itemViews[model.cid]
        },
        update: function() {
            this.$('.sectiontitle').text(this.model.get("title"))
        }
    })
    
    window.ContentView = Backbone.View.extend({
        el: $("#content"),
        render: function() {
            //console.log("content render")
            this.el.html("<h1 class='title'></h1><div class='sections'></div>")
            this.makeSortable()
            this.update()
            return this
        },
        initialize: function() {
            this.sectionViews = {}
            //console.log("binding add:sections")
            this.model.bind('change', this.update, this)
            this.model.bind("update:sections", this.updateSections, this)
            this.model.bind("add:sections", this.addSections, this)
            this.model.bind("remove:sections", this.removeSections, this)
            this.render()
        },
        updateSections: function(model, coll) {
            //alert('update sections')
        },
        addSections: function(model, coll) {
            //console.log("addSections:", model)
            this.sectionViews[model.cid] = new SectionView({model: model})
            this.$('.sections').append(this.sectionViews[model.cid].el)
        },
        removeSections: function(model, coll) {
            //console.log("removeSections:", model)
            $(this.sectionViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
            delete this.sectionViews[model.cid]
        },
        makeSortable: function() {
            var self = this
            this.$('.sections').sortable({
                update: function(event, ui) {
                    // get the post-sort section order (as a list of id's) and save the new collection order 
                    var new_order = self.$('.sections').sortable("toArray")
                    self.model.get('sections').reorder(new_order)
                    self.model.save()
                },
                opacity: 0.6,
                tolerance: "pointer"
            })
        },
        update: function() {
            this.$('.title').text(this.model.get("title"))
        }
    })
    
    window.content = new Content({_id: "4eb60623adea32365e000001"})
    
    window.contentview = new ContentView({model: content})
    
    content.fetch().then(function() {
        //content.get('sections').at(1).set({title: 'Books'})
        //content.get('sections').at(0).set('items', [{stuff: "woooo", _id:33}])
        
    })
    
})

</script>

<div id="content"></div>

<div id="jsoncode"></div>

</body>
</html>
